CREATE DATABASE IF NOT EXISTS pipe;
CREATE TABLE IF NOT EXISTS pipe.pipe_user (`uuid` String DEFAULT concat('PIPE-', hex(SHA256(UUIDStringToNum(toString(generateUUIDv4()))))) CODEC(LZ4HC(9)),`avatar` String, `ip` String DEFAULT '0.0.0.0', `github_id` UInt32, `wechat_id` UInt32 DEFAULT 0, `create_time` DateTime('Asia/Hong_Kong') DEFAULT now(), INDEX github_id_idx (github_id) TYPE minmax GRANULARITY 32, INDEX wechat_id_idx (wechat_id) TYPE minmax GRANULARITY 32) ENGINE = MergeTree() PRIMARY KEY (uuid, github_id, wechat_id);
CREATE TABLE IF NOT EXISTS pipe.pipe_config (`uuid` String CODEC(LZ4HC(9)),`name` String, `config` String DEFAULT '{}' CODEC(LZ4HC(9)), `create_time` DateTime('Asia/Hong_Kong') DEFAULT now(), `error_times` UInt16 DEFAULT 0) ENGINE = MergeTree() PRIMARY KEY (uuid, name);
CREATE TABLE IF NOT EXISTS pipe.pipe_wxwork (`corpid` String, `agent_id` UInt32, `access_token` String CODEC(LZ4HC(9)), `update_time` DateTime('Asia/Hong_Kong') DEFAULT now()) ENGINE = MergeTree() TTL update_time + INTERVAL 1 HOUR PRIMARY KEY (corpid, agent_id);
CREATE TABLE IF NOT EXISTS pipe.pipe_message (`uuid` String CODEC(LZ4HC(9)), `message_id` String CODEC(LZ4HC(9)), `title` String CODEC(LZ4HC(9)), `message` String CODEC(LZ4HC(9)), `update_time` DateTime('Asia/Hong_Kong') DEFAULT now()) ENGINE = MergeTree() TTL update_time + INTERVAL 7 DAY PRIMARY KEY (uuid, message_id);
CREATE TABLE IF NOT EXISTS pipe.pipe_platform_config (`name` String, `value` String) ENGINE = MergeTree() PRIMARY KEY (name);